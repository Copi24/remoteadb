name: Deploy Cloudflare Worker

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "cloudflare-worker/**"
      - ".github/workflows/deploy-cloudflare-worker.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Deploy worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          workingDirectory: cloudflare-worker
          command: deploy worker.js --name remoteadb-provision --compatibility-date 2025-12-29

      - name: Set Worker secrets
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          npm install -g wrangler@3
          cd cloudflare-worker
          printf %s "${CF_API_TOKEN}" | wrangler secret put CF_API_TOKEN --name remoteadb-provision || true
          printf %s "${CF_ACCOUNT_ID}" | wrangler secret put CF_ACCOUNT_ID --name remoteadb-provision || true
          printf %s "${CF_ZONE_ID}" | wrangler secret put CF_ZONE_ID --name remoteadb-provision || true
          printf %s "676967.xyz" | wrangler secret put CF_DNS_SUFFIX --name remoteadb-provision || true

      - name: Ensure Worker route
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          set -euo pipefail
          api="https://api.cloudflare.com/client/v4"
          script="remoteadb-provision"
          
          # Route for api.676967.xyz/*
          for pattern in "api.676967.xyz/*" "676967.xyz/*"; do
            routes_json=$(curl -fsS -H "Authorization: Bearer ${CF_API_TOKEN}" "${api}/zones/${CF_ZONE_ID}/workers/routes")
            existing_id=$(echo "$routes_json" | jq -r ".result[] | select(.pattern==\"${pattern}\") | .id" | head -n1)

            if [ -z "${existing_id}" ] || [ "${existing_id}" = "null" ]; then
              curl -fsS -X POST -H "Authorization: Bearer ${CF_API_TOKEN}" -H "Content-Type: application/json" \
                -d "{\"pattern\":\"${pattern}\",\"script\":\"${script}\"}" \
                "${api}/zones/${CF_ZONE_ID}/workers/routes" >/dev/null
              echo "Created route ${pattern} -> ${script}"
            else
              curl -fsS -X PUT -H "Authorization: Bearer ${CF_API_TOKEN}" -H "Content-Type: application/json" \
                -d "{\"pattern\":\"${pattern}\",\"script\":\"${script}\"}" \
                "${api}/zones/${CF_ZONE_ID}/workers/routes/${existing_id}" >/dev/null
              echo "Updated route ${pattern} -> ${script}"
            fi
          done

      - name: Ensure DNS for api subdomain
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          set -euo pipefail
          api="https://api.cloudflare.com/client/v4"
          
          # Create DNS records for both api.676967.xyz and 676967.xyz (root)
          for record in "api:api.676967.xyz" "@:676967.xyz"; do
            name="${record%%:*}"
            hostname="${record##*:}"
            
            dns_json=$(curl -fsS -H "Authorization: Bearer ${CF_API_TOKEN}" \
              "${api}/zones/${CF_ZONE_ID}/dns_records?type=A&name=${hostname}")
            existing_id=$(echo "$dns_json" | jq -r ".result[0].id // empty")

            dns_body="{\"type\":\"A\",\"name\":\"${name}\",\"content\":\"192.0.2.1\",\"ttl\":1,\"proxied\":true}"

            if [ -z "${existing_id}" ]; then
              curl -fsS -X POST -H "Authorization: Bearer ${CF_API_TOKEN}" -H "Content-Type: application/json" \
                -d "${dns_body}" "${api}/zones/${CF_ZONE_ID}/dns_records" >/dev/null
              echo "Created DNS A record for ${hostname}"
            else
              curl -fsS -X PUT -H "Authorization: Bearer ${CF_API_TOKEN}" -H "Content-Type: application/json" \
                -d "${dns_body}" "${api}/zones/${CF_ZONE_ID}/dns_records/${existing_id}" >/dev/null
              echo "Updated DNS A record for ${hostname}"
            fi
          done
